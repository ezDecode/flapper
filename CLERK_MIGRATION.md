# Clerk Authentication Migration Guide

This document describes the changes made to migrate from NextAuth to Clerk authentication.

## ‚úÖ Changes Completed

### 1. Dependencies

**Installed:**
- `@clerk/nextjs` (web app)
- `@clerk/backend` (API)
- `svix` (webhook verification)

**Removed:**
- `next-auth`
- `@fastify/jwt`

### 2. Environment Variables

Updated `.env.example` with new Clerk variables. **You must add these to your `.env` file:**

```env
# Clerk Authentication
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_...
CLERK_SECRET_KEY=sk_test_...
CLERK_WEBHOOK_SECRET=whsec_...
```

**Removed variables (no longer needed):**
- `NEXTAUTH_URL`
- `NEXTAUTH_SECRET`
- `JWT_SECRET`

### 3. Database Schema

**Modified:** `packages/db/prisma/schema.prisma`

The `User.id` field now stores the Clerk user ID directly (removed `@default(cuid())`).

**Migration required:**
```bash
pnpm db:generate
pnpm db:push  # or create a migration with: pnpm db:migrate
```

### 4. Next.js Application

**Created:**
- `apps/web/middleware.ts` - Clerk middleware for route protection
- `apps/web/app/api/webhooks/clerk/route.ts` - Webhook handler for user sync

**Modified:**
- `apps/web/app/layout.tsx` - Wrapped with `ClerkProvider`, added `UserButton`
- `apps/web/app/(auth)/login/page.tsx` - Now uses Clerk's `<SignIn>` component
- `apps/web/app/(auth)/register/page.tsx` - Now uses Clerk's `<SignUp>` component
- `apps/web/lib/api-client.ts` - Attaches Clerk session token to API requests

**Deleted:**
- `apps/web/app/api/auth/[...nextauth]/route.ts`
- `apps/web/lib/auth.ts`
- `apps/web/types/next-auth.d.ts`

### 5. Fastify API

**Modified:**
- `apps/api/src/plugins/auth.ts` - Now verifies Clerk session tokens instead of JWT
- `apps/api/src/types/fastify.d.ts` - Updated type definitions for `request.user`
- `apps/api/src/index.ts` - Removed auth routes registration

**Deleted:**
- `apps/api/src/routes/auth.ts` (old login/register/refresh/logout endpoints)

### 6. Platform OAuth Tokens

**No changes** - Platform OAuth tokens remain stored in the database as before. The `PlatformConnection` table and token encryption are unchanged. Workers continue to access tokens directly from the database.

## üîß Setup Instructions

### 1. Create a Clerk Application

1. Go to https://clerk.com and sign up
2. Create a new application
3. Choose your authentication methods (email/password, social logins, etc.)
4. Copy your publishable key and secret key

### 2. Configure Environment Variables

Add to your `.env` file:

```env
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=your_publishable_key
CLERK_SECRET_KEY=your_secret_key
```

### 3. Set Up Clerk Webhook

1. In your Clerk Dashboard, go to **Webhooks**
2. Create a new endpoint pointing to your production URL:
   ```
   https://your-domain.com/api/webhooks/clerk
   ```
   For local development with a tunnel (e.g., ngrok):
   ```
   https://your-ngrok-url.ngrok.io/api/webhooks/clerk
   ```
3. Select these events:
   - `user.created`
   - `user.updated`
   - `user.deleted`
4. Copy the webhook secret and add to your `.env`:
   ```env
   CLERK_WEBHOOK_SECRET=whsec_...
   ```

### 4. Update Database

Run Prisma commands to update your database schema:

```bash
pnpm --filter @omniplug/db generate
pnpm --filter @omniplug/db push
```

### 5. Test the Integration

1. Start your application:
   ```bash
   pnpm dev
   ```

2. Visit `/register` to create a new account
3. Check that:
   - User is created in Clerk
   - User sync webhook creates entry in your database
   - Dashboard routes are protected
   - API requests include Clerk session token

## üîê How It Works

### User Authentication Flow

1. **Sign Up/Sign In:** Users authenticate via Clerk's UI components
2. **Session Management:** Clerk manages session tokens
3. **Database Sync:** Clerk webhooks keep your database in sync with Clerk's user data
4. **API Authorization:** Frontend includes Clerk token in API requests, API verifies token

### API Request Flow

```
Frontend (Next.js)
  ‚Üì (gets Clerk token via auth())
  ‚Üì Authorization: Bearer <clerk-token>
  ‚Üì
API (Fastify)
  ‚Üì (verifies token with @clerk/backend)
  ‚Üì (attaches user.id to request)
  ‚Üì
Protected Route Handler
  ‚Üì (uses request.user.id)
```

### Platform OAuth (Unchanged)

Platform connections (Twitter, LinkedIn, Instagram, Bluesky) still need their own OAuth flows. These tokens are stored encrypted in the `PlatformConnection` table and accessed by workers directly from the database.

## üìù Migration Notes

### User ID Changes

- **Before:** User IDs were CUIDs generated by Prisma
- **After:** User IDs are Clerk user IDs (e.g., `user_2abc...`)

If you have existing users, you'll need to migrate them to Clerk or handle a data migration.

### Protected Routes

Routes are protected by default. Public routes are defined in `apps/web/middleware.ts`:

```typescript
const isPublicRoute = createRouteMatcher(["/", "/login(.*)", "/register(.*)", "/api/webhooks/clerk"]);
```

Add more routes to this array if needed.

### Social OAuth Integration

If you want to keep Twitter/LinkedIn/Instagram login via Clerk:

1. Enable those providers in your Clerk Dashboard
2. Add your OAuth client credentials to Clerk (not .env)
3. Clerk will handle the OAuth flow
4. You still need to handle platform token storage separately for posting

## üö® Important Security Notes

1. **Never expose `CLERK_SECRET_KEY` in client-side code**
2. **Webhook endpoint is public** - it verifies requests using `CLERK_WEBHOOK_SECRET`
3. **Platform OAuth tokens** are encrypted using `TOKEN_ENCRYPTION_KEY` (unchanged)

## üìö Additional Resources

- [Clerk Documentation](https://clerk.com/docs)
- [Next.js Integration Guide](https://clerk.com/docs/quickstarts/nextjs)
- [Webhooks Guide](https://clerk.com/docs/integrations/webhooks)
- [Backend API Reference](https://clerk.com/docs/references/backend/overview)
