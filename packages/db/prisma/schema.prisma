generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum Platform {
  TWITTER
  LINKEDIN
  INSTAGRAM
  BLUESKY
}

enum PostStatus {
  DRAFT
  SCHEDULED
  PUBLISHING
  PUBLISHED
  FAILED
}

enum PlugStatus {
  PENDING
  FIRED
  SKIPPED
  FAILED
}

enum TriggerType {
  LIKES
  COMMENTS
  REPOSTS
  TIME_AFTER_PUBLISH
}

enum JobType {
  PUBLISH_POST
  POLL_ENGAGEMENT
  FIRE_PLUG
}

enum JobStatus {
  PENDING
  PROCESSING
  DONE
  FAILED
}

enum Plan {
  FREE
  PRO
  AGENCY
}

model User {
  id                   String               @id @default(cuid())
  email                String               @unique
  name                 String?
  avatarUrl            String?
  plan                 Plan                 @default(FREE)
  stripeCustomerId     String?              @unique
  stripeSubscriptionId String?              @unique
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  platformConnections  PlatformConnection[]
  posts                Post[]
}

model PlatformConnection {
  id             String    @id @default(cuid())
  userId         String
  platform       Platform
  platformUserId String
  platformHandle String
  accessToken    String
  refreshToken   String?
  tokenExpiresAt DateTime?
  scopes         String[]
  isActive       Boolean   @default(true)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, platform])
}

model Post {
  id          String      @id @default(cuid())
  userId      String
  content     String
  mediaUrls   String[]
  status      PostStatus  @default(DRAFT)
  scheduledAt DateTime?
  publishedAt DateTime?
  failReason  String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  targets     PostTarget[]
  autoPlugs   AutoPlug[]
  jobs        Job[]
}

model PostTarget {
  id               String    @id @default(cuid())
  postId           String
  platform         Platform
  platformPostId   String?
  platformPostUrl  String?
  likesCount       Int       @default(0)
  commentsCount    Int       @default(0)
  repostsCount     Int       @default(0)
  impressionsCount Int       @default(0)
  lastPolledAt     DateTime?
  publishedAt      DateTime?
  failReason       String?
  post             Post      @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([postId, platform])
}

model AutoPlug {
  id           String      @id @default(cuid())
  postId       String
  platform     Platform
  plugContent  String
  triggerType  TriggerType @default(LIKES)
  triggerValue Int
  status       PlugStatus  @default(PENDING)
  firedAt      DateTime?
  plugPostId   String?
  failReason   String?
  createdAt    DateTime    @default(now())
  post         Post        @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([postId, platform])
}

model Job {
  id          String    @id @default(cuid())
  postId      String
  bullmqJobId String?   @unique
  type        JobType
  status      JobStatus @default(PENDING)
  attempts    Int       @default(0)
  maxAttempts Int       @default(3)
  payload     Json
  lastRunAt   DateTime?
  completedAt DateTime?
  error       String?
  createdAt   DateTime  @default(now())
  post        Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
}

